
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Blog to share my thoughts, news and ideas">
      
      
      
        <meta name="author" content="Denis Mulyalin">
      
      
        <link rel="canonical" href="https://dmulyalin.github.io/2023-02-05-templating-network-tests/">
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.2.4, mkdocs-material-7.2.2">
    
    
      
        <title>Templating Network Tests - Denis Mulyalin Blog</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.1118c9be.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.ba0d045b.min.css">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Serif+Pro:300,400,400i,700%7C&display=fallback">
        <style>:root{--md-text-font-family:"Source Serif Pro";--md-code-font-family:""}</style>
      
    
    
    
      <link rel="stylesheet" href="../stylesheets/extra.css">
    
    
      


    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="grey" data-md-color-accent="indigo">
  
    
    <script>function __prefix(e){return new URL("..",location).pathname+"."+e}function __get(e,t=localStorage){return JSON.parse(t.getItem(__prefix(e)))}</script>
    
      <script>var palette=__get("__palette");if(null!==palette&&"object"==typeof palette.color)for(var key in palette.color)document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#introduction" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Denis Mulyalin Blog" class="md-header__button md-logo" aria-label="Denis Mulyalin Blog" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Denis Mulyalin Blog
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Templating Network Tests
            
          </span>
        </div>
      </div>
    </div>
    
      <form class="md-header__option" data-md-component="palette">
        
          
          
          <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="grey" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
          
            <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69z"/></svg>
            </label>
          
        
          
          
          <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="grey" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_2">
          
            <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12c0-2.42-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69z"/></svg>
            </label>
          
        
      </form>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  
  


  <li class="md-tabs__item">
    <a href=".." class="md-tabs__link">
      About
    </a>
  </li>

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../posts/" class="md-tabs__link">
        Blog
      </a>
    </li>
  

      
        
  
  
    
  


  
  
  
    <li class="md-tabs__item">
      <a href="./" class="md-tabs__link md-tabs__link--active">
        Posts
      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Denis Mulyalin Blog" class="md-nav__button md-logo" aria-label="Denis Mulyalin Blog" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    Denis Mulyalin Blog
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        About
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" >
      
      <label class="md-nav__link" for="__nav_2">
        Blog
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Blog" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          Blog
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../posts/" class="md-nav__link">
        Blog Posts
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" checked>
      
      <label class="md-nav__link" for="__nav_3">
        Posts
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Posts" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          Posts
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Templating Network Tests
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Templating Network Tests
      </a>
      
        
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#introduction" class="md-nav__link">
    Introduction
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#meet-nornir-testsprocessor" class="md-nav__link">
    Meet Nornir TestsProcessor
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#scaling-up-using-salt-nornir" class="md-nav__link">
    Scaling Up using Salt-Nornir
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#adding-netbox-into-the-mix" class="md-nav__link">
    Adding Netbox into the mix
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#conclusion" class="md-nav__link">
    Conclusion
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../2022-08-21-5-efficient-ways-to-collect-show-commands-output-from-network-devices/" class="md-nav__link">
        5 Efficient Ways to Collect Show Commands Output From Network Devices
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#introduction" class="md-nav__link">
    Introduction
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#meet-nornir-testsprocessor" class="md-nav__link">
    Meet Nornir TestsProcessor
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#scaling-up-using-salt-nornir" class="md-nav__link">
    Scaling Up using Salt-Nornir
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#adding-netbox-into-the-mix" class="md-nav__link">
    Adding Netbox into the mix
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#conclusion" class="md-nav__link">
    Conclusion
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
                
                  <h1>Templating Network Tests</h1>
                
                <blockquote>
<p>5 Feb 2023 by Denis Mulyalin</p>
</blockquote>
<h2 id="introduction">Introduction<a class="headerlink" href="#introduction" title="Permanent link">#</a></h2>
<p>Templating network devices configuration is a very common approach nowadays,
network testing however, is rarely ( if at all) automated. Jinja2 comes to mind 
when somebody mentions network templates, YAML also pops up as a common way 
of expressing network related data.</p>
<p>SaltStack, Ansible, Nornir and others provide native support for workflows and 
payload templating using popular templating languages, this however rarely used to 
automate network tests.</p>
<p>The difficulty of doing network testing is due to the lack of structured data that 
can be easily extracted from network devices. As a result, one of common ways of 
dealing with network testing is to use show commands output to interpret devices state 
and operator using that output coupled with expert knowledge decides if device
is in a desired state or needs remediation.</p>
<p>Luckily, if system created that can use plain text to encode tests content to 
carry on with testing, that system is very close to templating those steps using 
data driven approach.</p>
<h2 id="meet-nornir-testsprocessor">Meet Nornir TestsProcessor<a class="headerlink" href="#meet-nornir-testsprocessor" title="Permanent link">#</a></h2>
<p>In one of my previous 
<a href="https://nornir.tech/2021/08/06/testing-your-network-with-nornir-testsprocessor/">blog posts</a>
I had a chance to write about the fact that network tests can be classified based on
the scope as local (unit), adjacent (integration) and network (system) tests, the focus of
this write up is mainly on local and adjacent types of scenarios. This is due to the fact
that TestProcessor was created to deal with data produced by a single device only.</p>
<p>Original vision behind TestsProcessor was to take a piece of static YAML text:</p>
<div class="highlight"><pre><span></span><code><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Software version test</span><span class="w"></span>
<span class="w">  </span><span class="nt">task</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">show version</span><span class="w"></span>
<span class="w">  </span><span class="nt">test</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">contains</span><span class="w"></span>
<span class="w">  </span><span class="nt">pattern</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;17.3.1&quot;</span><span class="w"></span>
<span class="w">  </span><span class="nt">err_msg</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Software version is wrong</span><span class="w"></span>

<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Logging configuration check</span><span class="w"></span>
<span class="w">  </span><span class="nt">task</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;show</span><span class="nv"> </span><span class="s">run</span><span class="nv"> </span><span class="s">|</span><span class="nv"> </span><span class="s">inc</span><span class="nv"> </span><span class="s">logging&quot;</span><span class="w"></span>
<span class="w">  </span><span class="nt">test</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">contains</span><span class="w"></span>
<span class="w">  </span><span class="nt">pattern</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10.0.0.1</span><span class="w"></span>
<span class="w">  </span><span class="nt">err_msg</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Logging configuration is wrong</span><span class="w"></span>
</code></pre></div>
<p>collect output from network devices and give us tests results:</p>
<div class="highlight"><pre><span></span><code>+----+--------+-----------------------------+----------+---------------------------+
|    | host   | name                        | result   | exception                 |
+====+========+=============================+==========+===========================+
|  0 | R1     | Software version test       | FAIL     | Software version is wrong |
+----+--------+-----------------------------+----------+---------------------------+
|  1 | R1     | Logging configuration check | PASS     |                           |
+----+--------+-----------------------------+----------+---------------------------+
</code></pre></div>
<p>Another networking industry common approach is to take data like:</p>
<div class="highlight"><pre><span></span><code>HostName: switch1

Vlans:
  - VlanId: 10
    VlanName: MGMT
  - VlanId: 20
    VlanName: ACCESS
</code></pre></div>
<p>combine with Jinja2 template:</p>
<div class="highlight"><pre><span></span><code>hostname {{ HostName }}
!
{% for Vlan in Vlans -%}
vlan {{ Vlan[&#39;VlanId&#39;] }}
  name {{ Vlan[&#39;VlanName&#39;] }}
!
{% endfor -%}
</code></pre></div>
<p>and produce network device configuration:</p>
<div class="highlight"><pre><span></span><code>hostname switch1
!
vlan 10
  name MGMT
!
vlan 20
  name ACCESS
</code></pre></div>
<p>Bringing two above approaches together leads to conclusion that it should 
be possible to make TestsProcessor tests suites dynamic - driven entirely 
by host's data. For example, if we have these two Nornir hosts:</p>
<div class="highlight"><pre><span></span><code>hosts:
  jundevice-1:
    hostname: 10.0.0.1
    platform: juniper_junos
    groups: [&quot;auth&quot;]
    data:
      software_version: 18.1R3-S9
  xrdevice-1:
    hostname: 10.0.0.2
    platform: cisco_xr
    groups: [&quot;auth&quot;]
    data:
      software_version: 7.5.2

groups:
  auth:
    username: nornir
    password: nornir
</code></pre></div>
<p>it is possible to write Jinja2 template like this:</p>
<div class="highlight"><pre><span></span><code>- name: Software version test
  task: show version
  test: contains
  pattern: {{ host.software_version }}
  err_msg: Software version is wrong
</code></pre></div>
<p>producing host specific tests to run to validate device software version.</p>
<p>Above idea was implemented in Nornir-Salt starting with release 0.16.0</p>
<h2 id="scaling-up-using-salt-nornir">Scaling Up using Salt-Nornir<a class="headerlink" href="#scaling-up-using-salt-nornir" title="Permanent link">#</a></h2>
<p>Using Nornir to run tests for a handful (up to hundreds) of devices is great, but
doing same for bigger number (thousands) of devices requires non trivial
engineering. </p>
<p>Salt-Nornir helps to scale network management using Nornir based proxy minions,
each handling multiple devices. Hence, network testing also can be scaled out
using Salt-Nornir proxy minions.</p>
<p>For example, given the test suite on a master at <code>/etc/salt/master/tests/testsuite-1.txt</code>:</p>
<div class="highlight"><pre><span></span><code>- task: &quot;show version&quot;
  test: contains
  pattern: &quot;{{ host.software_version }}&quot;
  name: check ceos version

{% for interface in host.interfaces %}
- task: &quot;show interface {{ interface.name }}&quot;
  test: contains_lines
  pattern: 
    - {{ interface.admin_status }}
    - {{ interface.line_status }}
    - {{ interface.mtu }}
    - {{ interface.description }}
  name: check interface {{ interface.name }} status
{% endfor %}
</code></pre></div>
<p>coupled with this proxy minion pillar inventory:</p>
<div class="highlight"><pre><span></span><code>hosts:
  ceos1:
    hostname: 10.0.1.4
    platform: arista_eos
    username: nornir
    password: nornir
    data:
      software_version: cEOS
      interfaces:
        - name: Ethernet1
          admin_status: is up
          description: East-West Campus uplink
          line_status: line protocol is up
          mtu: IP MTU 9200
        - name: Loopback0
          admin_status: is up
          description: RID and MGMT loopback
          line_status: line protocol is up
          mtu: IP MTU 1500
</code></pre></div>
<p>tests suite can be run using command:</p>
<div class="highlight"><pre><span></span><code>[root@salt-master /]# salt nrp1 nr.test suite=&quot;salt://tests/testsuite-1.txt&quot; table=brief
nrp1:
    +----+--------+----------------------------------+----------+-------------+
    |    | host   | name                             | result   | exception   |
    +====+========+==================================+==========+=============+
    |  0 | ceos1  | check ceos version               | PASS     |             |
    +----+--------+----------------------------------+----------+-------------+
    |  1 | ceos1  | check interface Ethernet1 status | PASS     |             |
    +----+--------+----------------------------------+----------+-------------+
    |  2 | ceos1  | check interface Loopback1 status | PASS     |             |
    +----+--------+----------------------------------+----------+-------------+
[root@salt-master /]# 
</code></pre></div>
<p>Resulting in tests content being dynamically rendered according to data stored in
host's inventory. Combine this with SaltStack reach data sourcing capabilities and
We have a workable solution to test our networks.</p>
<h2 id="adding-netbox-into-the-mix">Adding Netbox into the mix<a class="headerlink" href="#adding-netbox-into-the-mix" title="Permanent link">#</a></h2>
<p>Netbox is a DCIM/IPAM software to model and document modern networks. Salt-Nornir
comes with Netbox Pillar and Netbox Execution Modules, combined, they are capable 
of sourcing any data from Netbox over REST or GraphQL API right from your templates.</p>
<p>Netbox allows to model devices, here is an example of interfaces modeled in Netbox
for ceos1 device:</p>
<p><img alt="netbox-ceos1-interfaces" src="../images/netbox-ceos1-interfaces.png" /></p>
<p>Using Salt-Nornir execution module Netbox <code>get_interfaces</code> functions we can retrieve 
device interfaces data from Netbox:</p>
<div class="highlight"><pre><span></span><code>[root@salt-master /]# salt nrp1 nr.netbox get_interfaces device_name=ceos1 --out=yaml
nrp1:
  Ethernet1:
    bridge: null
    bridge_interfaces: []
    child_interfaces: []
    custom_fields: {}
    description: East-West Campus uplink
    duplex: FULL
    enabled: true
    last_updated: &#39;2022-12-30T11:21:59.922564+00:00&#39;
    mac_address: null
    member_interfaces: []
    mode: null
    mtu: 9200
    parent: null
    speed: null
    tagged_vlans: []
    tags: []
    untagged_vlan: null
    vrf: null
    wwn: null
  Loopback0:
    bridge: null
    bridge_interfaces: []
    child_interfaces: []
    custom_fields: {}
    description: RID and MGMT loopback
    duplex: null
    enabled: true
    last_updated: &#39;2022-12-30T11:22:32.225050+00:00&#39;
    mac_address: null
    member_interfaces: []
    mode: null
    mtu: 1500
    parent: null
    speed: null
    tagged_vlans: []
    tags: []
    untagged_vlan: null
    vrf: null
    wwn: null
</code></pre></div>
<p>SaltStack conveniently allows to call execution module functions from within the Jinja2 
templates, enabling us to source any data directly during template rendering process.
Lets use that in this template producing tests suite accordingly:</p>
<div class="highlight"><pre><span></span><code>{% set interfaces = salt[&#39;nr.netbox&#39;](&#39;get_interfaces&#39;, &#39;ceos1&#39;) %}

{% for interface_name, interface_data in interfaces.items() %}
- task: &quot;show interface {{ interface_name }}&quot;
  test: contains_lines
  pattern: 
    - {{ interface_data.mtu }}
    - {{ interface_data.description }}
{% if interface_data.enabled == True %}
    - &quot;is up, line protocol is up&quot;
{% elif interface_data.enabled == False %}
    - &quot;is down, admin down&quot;
{% endif %}
  name: check interface {{ interface_name }} status
{% endfor %}
</code></pre></div>
<p>Calling <code>salt['nr.netbox']('get_interfaces', 'ceos1')</code> inside of the template gives
us access to device interfaces data following with the <code>for</code> loop that renders individual
interface's tests. Running above tests suite produces these results:</p>
<div class="highlight"><pre><span></span><code>[root@salt-master /]# salt nrp1 nr.test suite=&quot;salt://tests/test_suite_ceos1_netbox.j2&quot; table=brief
nrp1:
    +----+--------+----------------------------------+----------+-----------+
    |    | host   | name                             | result   | exception |
    +====+========+==================================+==========+===========+
    |  0 | ceos1  | check interface Loopback0 status | PASS     |           |
    +----+--------+----------------------------------+----------+-----------+
    |  1 | ceos1  | check interface Ethernet1 status | PASS     |           |
    +----+--------+----------------------------------+----------+-----------+
</code></pre></div>
<p>There is also an option to do <code>dry_run</code> to produce tests suite content only without
running the actual tests:</p>
<div class="highlight"><pre><span></span><code>[root@salt-master /]# salt nrp1 nr.test suite=&quot;salt://tests/test_suite_ceos1_netbox.j2&quot; dry_run=True --out=yaml
nrp1:
  ceos1:
  - name: check interface Loopback0 status
    pattern:
    - 1500
    - RID and MGMT loopback
    - is up, line protocol is up
    task: show interface Loopback0
    test: contains_lines
  - name: check interface Ethernet1 status
    pattern:
    - 9200
    - East-West Campus uplink
    - is up, line protocol is up
    task: show interface Ethernet1
    test: contains_lines
[root@salt-master /]#
</code></pre></div>
<h2 id="conclusion">Conclusion<a class="headerlink" href="#conclusion" title="Permanent link">#</a></h2>
<p>Running data driven tests on devices show commands output is not an easy task,
Nornir TestsProcessor, SaltStack Salt-Nornir Proxy Minion and Netbox all combined 
or on its own, provide a great deal of flexibility and capabilities to successfully 
execute in that direction.</p>
<p>Thank you for reading to the end, all the best to you and your networks. </p>
<p>Feel free to comment on <a href="https://twitter.com/DMulyalin/status/1622124303750934528">Twitter</a>
or on <a href="https://github.com/dmulyalin/dmulyalin.github.io/discussions">GitHub</a>.</p>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
        
          <a href="#" class="md-top md-icon" data-md-component="top" data-md-state="hidden">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"/></svg>
            Back to top
          </a>
        
      </main>
      
        
<footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="Footer">
      
        
        <a href="../posts/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Blog Posts" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              Blog Posts
            </div>
          </div>
        </a>
      
      
        
        <a href="../2022-08-21-5-efficient-ways-to-collect-show-commands-output-from-network-devices/" class="md-footer__link md-footer__link--next" aria-label="Next: 5 Efficient Ways to Collect Show Commands Output From Network Devices" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              5 Efficient Ways to Collect Show Commands Output From Network Devices
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
        
      </div>
      
  <div class="md-footer-social">
    
      
      
        
        
      
      <a href="https://github.com/dmulyalin" target="_blank" rel="noopener" title="github.com" class="md-footer-social__link">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 480 512"><path d="M186.1 328.7c0 20.9-10.9 55.1-36.7 55.1s-36.7-34.2-36.7-55.1 10.9-55.1 36.7-55.1 36.7 34.2 36.7 55.1zM480 278.2c0 31.9-3.2 65.7-17.5 95-37.9 76.6-142.1 74.8-216.7 74.8-75.8 0-186.2 2.7-225.6-74.8-14.6-29-20.2-63.1-20.2-95 0-41.9 13.9-81.5 41.5-113.6-5.2-15.8-7.7-32.4-7.7-48.8 0-21.5 4.9-32.3 14.6-51.8 45.3 0 74.3 9 108.8 36 29-6.9 58.8-10 88.7-10 27 0 54.2 2.9 80.4 9.2 34-26.7 63-35.2 107.8-35.2 9.8 19.5 14.6 30.3 14.6 51.8 0 16.4-2.6 32.7-7.7 48.2 27.5 32.4 39 72.3 39 114.2zm-64.3 50.5c0-43.9-26.7-82.6-73.5-82.6-18.9 0-37 3.4-56 6-14.9 2.3-29.8 3.2-45.1 3.2-15.2 0-30.1-.9-45.1-3.2-18.7-2.6-37-6-56-6-46.8 0-73.5 38.7-73.5 82.6 0 87.8 80.4 101.3 150.4 101.3h48.2c70.3 0 150.6-13.4 150.6-101.3zm-82.6-55.1c-25.8 0-36.7 34.2-36.7 55.1s10.9 55.1 36.7 55.1 36.7-34.2 36.7-55.1-10.9-55.1-36.7-55.1z"/></svg>
      </a>
    
      
      
        
        
      
      <a href="https://twitter.com/DMulyalin" target="_blank" rel="noopener" title="twitter.com" class="md-footer-social__link">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg>
      </a>
    
  </div>

    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "..", "features": ["navigation.tabs", "navigation.tabs.sticky", "navigation.top"], "translations": {"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing", "select.version.title": "Select version"}, "search": "../assets/javascripts/workers/search.709b4209.min.js", "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.2b46852b.min.js"></script>
      
    
  </body>
</html>